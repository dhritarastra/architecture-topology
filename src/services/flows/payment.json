{
  "id": "f3",
  "label": "Payment Flow",
  "nodes": [
    "MoP",
    "dashboard-backend",
    "dashboard-web",
    "payment-web",
    "payment-service",
    "stripe",
    "licence-backend",
    "licence-service",
    "DB"
  ],
  "edges": [
    "e9",
    "e10",
    "e17",
    "e18",
    "e19",
    "e20",
    "e11",
    "e12",
    "e13",
    "e18",
    "e19",
    "e23",
    "e21",
    "e22",
    "e7"
  ],
  "steps": [
    {
      "id": "s1",
      "edgeId": "e9",
      "title": "MoP submits payment request",
      "nodeSchemas": {
        "MoP": {
          "Description": "Member of Public initiates payment"
        }
      }
    },
    {
      "id": "s2",
      "edgeId": "e10",
      "title": "dashboard-web calls DASHBOAED-BACKEND",
      "nodeSchemas": {
        "dashboard-web": {
          "request": {
            "Description": "Requests dashboard-backend to create payment request"
          }
        }
      }
    },
    {
      "id": "s3",
      "edgeId": "e17",
      "title": "dashboard-backend calls Payment Service",
      "nodeSchemas": {
        "dashboard-backend": {
          "request": {
            "Description": "Requests payment-service to create payment reference with metadata in JWE String"
          }
        }
      }
    },
    {
      "id": "s4",
      "edgeId": "e18",
      "title": "Payment Service calls stripe (first time)",
      "nodeSchemas": {
        "payment-service": {
          "request": {
            "Description": "Request to create stripe customer and return JWE String response"
          }
        }
      }
    },
    {
      "id": "s5",
      "edgeId": "e19",
      "title": "stripe responds to Payment Service (first time)",
      "nodeSchemas": {
        "stripe": {
          "response": {
            "Description": "stripe responds with JWE String to be set in the cookie post creation of stripe customer"
          }
        }
      }
    },
    {
      "id": "s6",
      "edgeId": "e20",
      "title": "Payment Service responds to dashboard-backend (first time)",
      "nodeSchemas": {
        "payment-service": {
          "response": {
            "Description": "JWE String response to be set in the cookie post creation of stripe customer"
          }
        }
      }
    },
    {
      "id": "s7",
      "edgeId": "e11",
      "title": "dashboard-backend responds to dashboard-web",
      "nodeSchemas": {
        "dashboard-backend": {
          "response": {
            "Description": "DASHBOARD_BACKEND sends the JWE String response to dashboard-web to be set in the cookie for redirect"
          }
        }
      }
    },
    {
      "id": "s8",
      "edgeId": "e12",
      "title": "dashboard-web redirects to payment-web",
      "nodeSchemas": {
        "dashboard-web": {
          "request": {
            "Description": "dashboard-web redirects to payment-web with set cookie"
          }
        }
      }
    },
    {
      "id": "s9",
      "edgeId": "e13",
      "title": "payment-web calls payment-service",
      "nodeSchemas": {
        "payment-web": {
          "request": {
            "Description": "payment-web sends tokenized stripe payment method to payment-service to initiate payment."
          }
        }
      }
    },
    {
      "id": "s10",
      "edgeId": "e18",
      "title": "payment-service calls stripe (second time)",
      "nodeSchemas": {
        "payment-service": {
          "request": {
            "Description": "payment-service calls stripe to create payment intent in Agency stripe account with payment method and domain reference data."
          }
        }
      }
    },
    {
      "id": "s11",
      "edgeId": "e19",
      "title": "stripe responds to payment-service (second time)",
      "nodeSchemas": {
        "stripe": {
          "response": {
            "Description": "stripe responds to payment-service with the outcome of the payment."
          }
        }
      }
    },
    {
      "id": "s12",
      "edgeId": "e23",
      "title": "payment-service calls dashboard-backend (second time)",
      "nodeSchemas": {
        "payment-service": {
          "request": {
            "Description": "payment-service calls dashboard-backend to notify the domain of the outcome of the payment processing."
          }
        }
      }
    },
    {
      "id": "s13",
      "edgeId": "e21",
      "title": "dashboard-backend calls licence-backend",
      "unhappy": [
        { "edgeId": "u1_5XX", "title": "Backend Error" }
      ],
      "nodeSchemas": {
        "dashboard-backend": {
          "request": {
            "Description": "dashboard-backend makes payment callback to licence-backend",
            "URI": "/payments/callback",
            "dummy-payload": {
              "domainReferences": [
                {
                  "domainReferenceId": "DR-000001",
                  "paymentReferenceNumber": "PRN-2026-000001",
                  "domainReferenceData": {
                    "entityName": "Acme Pte Ltd",
                    "typeCode": "LIC",
                    "applicationNumber": "APP-2026-000123"
                  },
                  "adviceNumber": "ADV-000001",
                  "description": "Licence application payment",
                  "domainCode": "LICENCE",
                  "agencyCode": "AGENCY1",
                  "stage": 1,
                  "createdAt": "2026-01-11T10:15:30Z",
                  "updatedAt": "2026-01-11T10:20:00Z",
                  "paymentTransactions": [
                    {
                      "transactionNumber": "TXN-000001",
                      "gatewayTransactionNumber": "GTW-1234567890",
                      "receiptNumber": "RCPT-000001",
                      "adviceNumber": "ADV-000001",
                      "status": "SUCCESS",
                      "paymentMethodType": "CARD",
                      "transactionCreatedAt": "2026-01-11T10:16:00Z",
                      "totalAmount": 120.5,
                      "totalTaxAmount": 8.4,
                      "createdAt": "2026-01-11T10:16:10Z",
                      "updatedAt": "2026-01-11T10:16:20Z"
                    },
                    {
                      "transactionNumber": "TXN-000002",
                      "gatewayTransactionNumber": null,
                      "receiptNumber": null,
                      "adviceNumber": "ADV-000001",
                      "status": "PENDING",
                      "paymentMethodType": "PAYNOW",
                      "transactionCreatedAt": "2026-01-11T10:18:00Z",
                      "totalAmount": 120.5,
                      "totalTaxAmount": 8.4,
                      "createdAt": "2026-01-11T10:18:10Z",
                      "updatedAt": "2026-01-11T10:18:20Z"
                    }
                  ],
                  "lineItems": [
                    {
                      "description": "Application fee",
                      "amount": 100,
                      "taxAmount": 7,
                      "previousPayment": "2025-12-01",
                      "nextPayment": "2026-12-01",
                      "createdAt": "2026-01-11T10:15:40Z",
                      "updatedAt": "2026-01-11T10:15:50Z"
                    },
                    {
                      "description": "Processing fee",
                      "amount": 20.5,
                      "taxAmount": 1.4,
                      "previousPayment": "2025-12-01",
                      "nextPayment": "2026-12-01",
                      "createdAt": "2026-01-11T10:15:41Z",
                      "updatedAt": "2026-01-11T10:15:51Z"
                    }
                  ]
                }
              ]
            }
          }
        }
      }
    },
    {
      "id": "s14",
      "edgeId": "e22",
      "title": "licence-backend calls licence-service",
      "unhappy": [
        { "edgeId": "u4_4XX", "title": "Bad Request / Validation Failed" }
      ],
      "nodeSchemas": {
        "licence-backend": {
          "request": {
            "Description": "licence-backend calls licence-service in case of successful payment to update licence/application status accordingly",
            "URI": "/applications/{applicationId}/submitV2",
            "dummy-payload": {
              "paymentInfo": {
                "paymentMode": "CARD",
                "paymentDate": "2026-01-11",
                "paymentAmount": "100.00",
                "transactionNumber": "TXN-123456789",
                "receiptNumber": "RCPT-987654321"
              },
              "sensitiveGeneralInfoAgencyData": {
                "general": {
                  "applicationNumber": "APP-2026-000001",
                  "dateSent": "2026-01-11T10:15:30Z",
                  "transactionType": "new",
                  "licenceName": "Sample Licence"
                },
                "profile": {
                  "applyAs": "As applicant",
                  "channel": "ONLINE"
                },
                "applicant": {
                  "name": "Jane Doe",
                  "idType": "NRIC",
                  "idNumber": "S1234567A",
                  "email": "jane.doe@example.com",
                  "contactNumber": "+65 9123 4567",
                  "address": {
                    "line1": "1 Example Street",
                    "line2": "#01-01",
                    "postalCode": "123456",
                    "country": "SG"
                  }
                },
                "filer": {
                  "name": "Jane Doe",
                  "idType": "NRIC",
                  "idNumber": "S1234567A",
                  "email": "jane.doe@example.com",
                  "contactNumber": "+65 9123 4567"
                },
                "company": {
                  "companyName": "Example Pte Ltd",
                  "uen": "201912345Z",
                  "entityType": "PRIVATE_LIMITED",
                  "registeredAddress": "1 Example Street, Singapore 123456"
                },
                "licence": {
                  "licenceType": "TYPE_A",
                  "licenceNumber": "LIC-000123",
                  "validFrom": "2026-01-01",
                  "validTo": "2027-01-01"
                },
                "edh": {
                  "sensitiveField1": "dummy",
                  "sensitiveField2": 123
                }
              },
              "loginId": "S1234567A"
            }
          }
        }
      }
    },
    {
      "id": "s15",
      "edgeId": "e7",
      "title": "licence-service writes into DB",
      "nodeSchemas": {
        "payment-web": {
          "request": {
            "Description": "licence-service updates the database with the payment and status update information",
            "Tables updated": "Application, Statemachine"
          }
        }
      }
    }
  ],
  "nodeSchemas": {}
}
